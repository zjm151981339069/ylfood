<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.spfood.oms.order.intf.domain.OrderExchange">
	<resultMap id="orderExchangeResultMap"
		type="com.spfood.oms.order.intf.domain.OrderExchange">
		<!-- WARNING - @mbggenerated This element is automatically generated by 
			MyBatis Generator, do not modify. -->
		<id column="EXCODE" property="exCode" jdbcType="VARCHAR" />
		<result column="EXID" property="exId" jdbcType="BIGINT" />
		<result column="ORDERNO" property="orderNo" jdbcType="VARCHAR" />
		<result column="APPTIME" property="appTime" jdbcType="TIMESTAMP" />
		<result column="CREATETIME" property="createTime" jdbcType="TIMESTAMP" />
		<result column="RECEIVER" property="receiver" jdbcType="VARCHAR" />
		<result column="RECEIVERCODE" property="receiverCode" jdbcType="VARCHAR" />
		<result column="PHONE" property="phone" jdbcType="VARCHAR" />
		<result column="USERNAME" property="username" jdbcType="VARCHAR" />
		<result column="USERNAMECODE" property="usernameCode" jdbcType="VARCHAR" />
		<result column="SITE" property="site" jdbcType="VARCHAR" />
		<result column="SITECODE" property="siteCode" jdbcType="VARCHAR" />
		<result column="DEALSTYLE" property="dealStyle" jdbcType="INTEGER" />
		<result column="ADDR" property="addr" jdbcType="VARCHAR" />
		<result column="AUDITSTATUS" property="auditstatus" jdbcType="INTEGER" />
		<result column="AUDITVIEW" property="auditview" jdbcType="VARCHAR" />

		<collection property="exchangeCommodityLists"
			ofType="com.spfood.oms.order.intf.domain.OrderExchangeCommodity" column="pid">
			<id column="EXCOMID" property="exComId" jdbcType="BIGINT" />
			<result column="EXCODE1" property="exCode" jdbcType="VARCHAR" />
			<result column="CODE" property="code" jdbcType="VARCHAR" />
			<result column="NAME" property="name" jdbcType="VARCHAR" />
			<result column="COUNT" property="count" jdbcType="INTEGER" />
			<result column="ISSUEDES" property="issuedes" jdbcType="VARCHAR" />
			<result column="PURL" property="purl" jdbcType="VARCHAR" />
			
			<collection property="pictureUrl"
				ofType="com.spfood.oms.order.intf.domain.ExchangePicture" column="pid">
				<id column="EXPID" property="exPid" jdbcType="BIGINT" />
				<result column="EXCODE2" property="exCode" jdbcType="VARCHAR" />
				<result column="CODE1" property="code" jdbcType="VARCHAR" />
				<result column="URL" property="url" jdbcType="VARCHAR" />
			</collection>
		</collection>

	</resultMap>
	<sql id="Base_Column_List">
		o.exId, o.exCode, o.orderNo, o.appTime, o.createTime,
		o.receiver,o.receiverCode,o.phone, o.username,o.usernameCode, o.site,o.siteCode,
		o.dealStyle, o.addr,
		o.auditview,o.auditstatus,
		c.exComId, c.exCode exCode1, c.name, c.issuedes,
		c.count,c.code,c.purl,e.code code1,e.exPid,e.exCode exCode2,e.url
	</sql>

	<sql id="query_where">
		<where>
				<if test="exCode != null" >
			         AND EXCODE = #{exCode}
			      </if>
				<if test="startDate != null">
					AND APPTIME >= #{startDate}
				</if>
				<if test="endDate != null">
					AND APPTIME <![CDATA[<=]]>
					#{endDate}
				</if>
				<if test="auditstatus != null">
					AND AUDITSTATUS = #{auditstatus}
				</if>
				<if test="receiver != null">
					AND RECEIVER like CONCAT('%',#{receiver},'%') 
				</if>
				<if test="usernameCode != null">
					AND USERNAMECODE = #{usernameCode}
				</if>
				
		</where>
	</sql>
	<!-- 修改展示订单 -->
	<select id="getExchangePage" resultMap="orderExchangeResultMap"
		parameterType="com.spfood.oms.order.intf.domain.OrderExchange">
		SELECT
		ooe.exId,ooe.exCode,ooe.orderNo,ooe.appTime, ooe.createTime,ooe.receiver,ooe.receiverCode,
		ooe.phone,ooe.username,ooe.usernameCode, ooe.site,ooe.siteCode, ooe.auditstatus
		FROM
		oms_order_exchange ooe
		<include refid="query_where" />
		ORDER BY ${sort}
	</select>
	<!-- 修改查询数量 -->
	<select id="selectCount" resultType="java.lang.Long"
		parameterType="com.spfood.oms.order.intf.domain.OrderExchange">
		SELECT count(1) FROM oms_order_exchange
		<include refid="query_where" />
	</select>
	
	<!-- 修改通过id查询换货单详情 -->
	<select id="selectByPrimaryKey"
		parameterType="com.spfood.oms.order.intf.domain.OrderExchange"
		resultMap="orderExchangeResultMap">
		SELECT
		<include refid="Base_Column_List" />
		FROM oms_order_exchange o LEFT JOIN
		oms_exchange_commodity c ON
		o.exCode = c.exCode LEFT JOIN oms_exchange_picture e ON e.exCode = c.exCode AND e.code= c.code
		WHERE o.exid =
		#{exid,jdbcType=VARCHAR}
	</select>

	<!-- 修改换货单审核操作 -->
	<update id="updateByPrimaryKey" parameterType="java.util.Map">
		UPDATE
		oms_order_exchange set auditstatus = #{auditstatus} , auditview = #{auditview}
		WHERE exId = #{exId}
	</update>

	<!-- 修改入库操作 -->
	<insert id="insert" parameterType="com.spfood.oms.order.intf.domain.OrderExchange">
		INSERT INTO oms_order_exchange
			(exCode,orderNo,appTime,createTime,receiver,receiverCode,phone,username,usernameCode,site,siteCode,dealStyle,addr,auditstatus,auditview)
		VALUES
			(#{exCode,jdbcType=VARCHAR},#{orderNo,jdbcType=VARCHAR},#{appTime,jdbcType=TIMESTAMP},
			#{createTime,jdbcType=TIMESTAMP},#{receiver,jdbcType=VARCHAR},#{receiverCode,jdbcType=VARCHAR},
			#{phone,jdbcType=VARCHAR},#{username,jdbcType=VARCHAR},#{usernameCode,jdbcType=VARCHAR},
			#{site,jdbcType=VARCHAR},#{siteCode,jdbcType=VARCHAR},#{dealStyle,jdbcType=BIGINT},
			#{addr,jdbcType=VARCHAR},#{auditstatus,jdbcType=BIGINT},#{auditview,jdbcType=VARCHAR});
		<if test="exchangeCommodityLists != null and exchangeCommodityLists.size() != 0">
		INSERT INTO oms_exchange_commodity (EXCODE, CODE, NAME, COUNT, ISSUEDES,PURL) 
		values 
		<foreach collection="exchangeCommodityLists" item="item" index="index" separator="," >  
		 (#{item.exCode,jdbcType=VARCHAR},#{item.code,jdbcType=VARCHAR},#{item.name,jdbcType=VARCHAR},#{item.count,jdbcType=INTEGER},#{item.issuedes,jdbcType=VARCHAR},#{item.purl,jdbcType=VARCHAR})
		 </foreach>;
<!-- 		<if test="pictureUrl != null and pictureUrl.size() != 0"> -->
<!-- 		 insert into oms_exchange_picture (CODE,EXCODE, URL) values  -->
<!-- 		 <foreach collection="pictureUrl" item="item" index="index" separator="," >   -->
<!-- 		 (#{item.code,jdbcType=VARCHAR},#{item.exCode,jdbcType=VARCHAR},#{item.url,jdbcType=VARCHAR}) -->
<!-- 		 </foreach> -->
<!-- 		</if> -->
		</if>
	</insert>

	<!-- 用户中心换货数量查询 -->
	<select id="getExchangeListTotalByCriteria" resultType="java.lang.Long"
		parameterType="com.spfood.oms.order.intf.domain.OrderExchange">
		SELECT  count(DISTINCT o.exCode)  FROM oms_order_exchange o 
		LEFT JOIN
		oms_exchange_commodity c ON
		o.exCode = c.exCode
		<where>
		<if test="exCode != null" >
			         AND o.EXCODE = #{exCode}
			      </if>
				<if test="startDate != null">
					AND o.APPTIME >= #{startDate}
				</if>
				<if test="endDate != null">
					AND o.APPTIME <![CDATA[<=]]>
					#{endDate}
				</if>
				<if test="auditstatus != null">
					AND o.AUDITSTATUS = #{auditstatus}
				</if>
				<if test="receiver != null">
					AND o.RECEIVER like CONCAT('%',#{receiver},'%') 
				</if>
				<if test="usernameCode != null">
					AND o.USERNAMECODE = #{usernameCode}
				</if>
				<if test="search != null">
					AND o.orderNo like CONCAT('%',#{search},'%')
				</if>
				<if test="search != null">
					OR c.name like CONCAT('%',#{search},'%')
				</if>
				<if test="search != null">
					OR c.code like CONCAT('%',#{search},'%')
				</if>
		</where>
	</select>
  
   <!-- 用户中心通过查询条件查询订单 进行列表展示-->
  <select id="select" resultMap="orderExchangeResultMap" parameterType="com.spfood.oms.order.intf.domain.OrderExchange" >
    SELECT <!-- DISTINCT --> 
    o.exCode,o.exId, o.orderNo,o.appTime,o.auditstatus,o.usernameCode ,o.dealStyle, c.exCode exCode1, c.name, c.issuedes,
		c.count,c.code,c.purl 
    FROM oms_order_exchange o 
    LEFT JOIN oms_exchange_commodity c ON o.exCode  =  c.exCode 
    <where>
    			<if test="exCode != null" >
			         AND o.EXCODE = #{exCode}
			      </if>
				<if test="startDate != null">
					AND o.APPTIME >= #{startDate}
				</if>
				<if test="endDate != null">
					AND o.APPTIME <![CDATA[<=]]>
					#{endDate}
				</if>
				<if test="auditstatus != null">
					AND o.AUDITSTATUS = #{auditstatus}
				</if>
				<if test="receiver != null">
					AND o.RECEIVER like CONCAT('%',#{receiver},'%') 
				</if>
				<if test="usernameCode != null">
					AND o.USERNAMECODE = #{usernameCode}
				</if>
			<if test="search != null">
			AND o.orderNo like CONCAT('%',#{search},'%')
			</if>
			<if test="search != null">
			AND o.exCode like CONCAT('%',#{search},'%')
			</if>
			<if test="search != null">
			OR c.name like CONCAT('%',#{search},'%')
			</if>
			<if test="search != null">
			OR c.code like CONCAT('%',#{search},'%')
			</if>
		</where>
		group by o.exCode 
    	ORDER BY o.apptime desc
  </select>

</mapper>